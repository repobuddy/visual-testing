import{_ as C}from"./iframe-DJcZLFuM.js";import{s as H,d as L,a as Q}from"./vitest_suite_proxy-CJMskv9z.js";function K(t){if(t!=null&&t.includes("-"))throw new Error("Snapshot key cannot contain dash")}const k=/^[A-Za-z]:\//;function ee(t=""){return t&&t.replace(/\\/g,"/").replace(k,r=>r.toUpperCase())}const te=/^[/\\](?![/\\])|^[/\\]{2}(?!\.)|^[A-Za-z]:[/\\]/;function ae(){return typeof process<"u"&&typeof process.cwd=="function"?process.cwd().replace(/\\/g,"/"):"/"}const p=function(...t){t=t.map(a=>ee(a));let r="",e=!1;for(let a=t.length-1;a>=-1&&!e;a--){const n=a>=0?t[a]:ae();!n||n.length===0||(r=`${n}/${r}`,e=j(n))}return r=re(r,!e),e&&!j(r)?`/${r}`:r.length>0?r:"."};function re(t,r){let e="",a=0,n=-1,s=0,o=null;for(let l=0;l<=t.length;++l){if(l<t.length)o=t[l];else{if(o==="/")break;o="/"}if(o==="/"){if(!(n===l-1||s===1))if(s===2){if(e.length<2||a!==2||e[e.length-1]!=="."||e[e.length-2]!=="."){if(e.length>2){const c=e.lastIndexOf("/");c===-1?(e="",a=0):(e=e.slice(0,c),a=e.length-1-e.lastIndexOf("/")),n=l,s=0;continue}else if(e.length>0){e="",a=0,n=l,s=0;continue}}r&&(e+=e.length>0?"/..":"..",a=2)}else e.length>0?e+=`/${t.slice(n+1,l)}`:e=t.slice(n+1,l),a=l-n-1;n=l,s=0}else o==="."&&s!==-1?++s:s=-1}return e}const j=function(t){return te.test(t)};function ne(t,r,e,a,n,s={}){const{threshold:o=.1,alpha:l=.1,aaColor:c=[255,255,0],diffColor:i=[255,0,0],includeAA:m,diffColorAlt:w,diffMask:f}=s;if(!v(t)||!v(r)||e&&!v(e))throw new Error("Image data: Uint8Array, Uint8ClampedArray or Buffer expected.");if(t.length!==r.length||e&&e.length!==t.length)throw new Error("Image sizes do not match.");if(t.length!==a*n*4)throw new Error("Image data size does not match width/height.");const d=a*n,h=new Uint32Array(t.buffer,t.byteOffset,d),u=new Uint32Array(r.buffer,r.byteOffset,d);let g=!0;for(let x=0;x<d;x++)if(h[x]!==u[x]){g=!1;break}if(g){if(e&&!f)for(let x=0;x<d;x++)V(t,4*x,l,e);return 0}const $=35215*o*o,[I,b,T]=c,[E,R,z]=i,[X,Z,q]=w||i;let D=0;for(let x=0;x<n;x++)for(let S=0;S<a;S++){const O=x*a+S,A=O*4,U=h[O]===u[O]?0:Y(t,r,A,A,!1);if(Math.abs(U)>$){const J=B(t,S,x,a,n,h,u)||B(r,S,x,a,n,u,h);!m&&J?e&&!f&&P(e,A,I,b,T):(e&&(U<0?P(e,A,X,Z,q):P(e,A,E,R,z)),D++)}else e&&!f&&V(t,A,l,e)}return D}function v(t){return ArrayBuffer.isView(t)&&t.BYTES_PER_ELEMENT===1}function B(t,r,e,a,n,s,o){const l=Math.max(r-1,0),c=Math.max(e-1,0),i=Math.min(r+1,a-1),m=Math.min(e+1,n-1),w=e*a+r;let f=r===l||r===i||e===c||e===m?1:0,d=0,h=0,u=0,g=0,$=0,I=0;for(let b=l;b<=i;b++)for(let T=c;T<=m;T++){if(b===r&&T===e)continue;const E=Y(t,t,w*4,(T*a+b)*4,!0);if(E===0){if(f++,f>2)return!1}else E<d?(d=E,u=b,g=T):E>h&&(h=E,$=b,I=T)}return d===0||h===0?!1:_(s,u,g,a,n)&&_(o,u,g,a,n)||_(s,$,I,a,n)&&_(o,$,I,a,n)}function _(t,r,e,a,n){const s=Math.max(r-1,0),o=Math.max(e-1,0),l=Math.min(r+1,a-1),c=Math.min(e+1,n-1),i=t[e*a+r];let m=r===s||r===l||e===o||e===c?1:0;for(let w=s;w<=l;w++)for(let f=o;f<=c;f++)if(!(w===r&&f===e)&&(m+=+(i===t[f*a+w]),m>2))return!0;return!1}function Y(t,r,e,a,n){const s=t[e],o=t[e+1],l=t[e+2],c=t[e+3],i=r[a],m=r[a+1],w=r[a+2],f=r[a+3];let d=s-i,h=o-m,u=l-w;const g=c-f;if(!d&&!h&&!u&&!g)return 0;if(c<255||f<255){const E=48+159*(e%2),R=48+159*((e/1.618033988749895|0)%2),z=48+159*((e/2.618033988749895|0)%2);d=(s*c-i*f-E*g)/255,h=(o*c-m*f-R*g)/255,u=(l*c-w*f-z*g)/255}const $=d*.29889531+h*.58662247+u*.11448223;if(n)return $;const I=d*.59597799-h*.2741761-u*.32180189,b=d*.21147017-h*.52261711+u*.31114694,T=.5053*$*$+.299*I*I+.1957*b*b;return $>0?-T:T}function P(t,r,e,a,n){t[r+0]=e,t[r+1]=a,t[r+2]=n,t[r+3]=255}function V(t,r,e,a){const n=255+(t[r]*.29889531+t[r+1]*.58662247+t[r+2]*.11448223-255)*e*t[r+3]/255;P(a,r,n,n,n)}function se({failureThresholdType:t,width:r,height:e},a){switch(t){case"pixel":return a;case"percent":return a/(r*e)*100;default:throw new Error(`Unsupported failureThresholdType: ${t}`)}}function le(t,r,e,a,n,s={}){const o=s.comparisonMethod==="ssim"?ce(t,r,e,a,n,s.diffOptions):ne(t,r,e,a,n,s.diffOptions),l=se({failureThresholdType:s.failureThresholdType??"pixel",width:a,height:n},o);return{pass:l<=(s.failureThreshold??0),diffAmount:l}}function ce(t,r,e,a,n,s){const o={data:t,width:a,height:n},l={data:r,width:a,height:n},{ssim_map:c,mssim:i}=H.ssim(o,l,{ssim:"bezkrovny",...s}),m=Math.round((1-i)*a*n),w=new DataView(e.buffer,e.byteOffset);for(let f=0;f!==n;++f)for(let d=0;d!==a;++d){const h=f*a+d,u=4278190080+Math.floor(255*(1-c.data[c.width*Math.round(c.height*f/n)+Math.round(c.width*d/a)]));w.setUint32(h*4,u)}return m}function oe(t,r){const e=Math.max(t.width,r.width),a=Math.max(t.height,r.height);return{width:e,height:a}}function N(t,r){return t.width===r.width&&t.height===r.height}const fe=({width:t,height:r})=>e=>{if(N(e,{width:t,height:r}))return e;const a=(o,l)=>l<=e.height&&o<=e.width,n=new Uint8ClampedArray(t*r*4),s=new ImageData(n,t,r,{colorSpace:e.colorSpace});for(let o=0;o<r;o++)for(let l=0;l<t;l++){const c=t*o+l<<2;if(a(l,o)){const i=e.width*o+l<<2;s.data[c]=e.data[i],s.data[c+1]=e.data[i+1],s.data[c+2]=e.data[i+2],s.data[c+3]=e.data[i+3]}else s.data[c]=0,s.data[c+1]=0,s.data[c+2]=0,s.data[c+3]=64}return s};function ie(t,r){if(N(t,r))return[t,r];const e=oe(t,r),a=fe(e);return[a(t),a(r)]}function F(t){return t?[`failureThreshold: ${t.failureThreshold??0} ${t.failureThresholdType??"pixels"}`,t.timeout?`timeout: ${t.timeout} ms`:"",`comparisonMethod: ${t.comparisonMethod??"pixel"}`,t.diffOptions?`diffOptions: ${JSON.stringify(t.diffOptions)}`:""].filter(Boolean).join(`
                 `):"none"}function G(t){return new Promise((r,e)=>{const a=new Image;a.src=`data:image/png;base64,${t}`,a.onload=()=>{const n=document.createElement("canvas");n.width=a.width,n.height=a.height;const s=n.getContext("2d");s.drawImage(a,0,0),r(s.getImageData(0,0,n.width,n.height))},a.onerror=()=>{e(new Error("Failed to load image"))}})}async function de(t){const r=document.createElement("canvas");return r.width=t.width,r.height=t.height,r.getContext("2d").putImageData(t,0,0),new Promise(a=>{r.toBlob(n=>{const s=new FileReader;s.onload=()=>{a(s.result)},s.readAsDataURL(n)})})}async function he(t,r,e,a){a={...e,...a};const n=await G(e.baseline),s=await G(e.result),[o,l]=ie(n,s),{width:c,height:i}=o,m=new ImageData(c,i),{pass:w,diffAmount:f}=le(o.data,l.data,m.data,c,i,a);if(w){if(a!=null&&a.expectToFail)throw new Error(L`Snapshot \`${r}\` matched but expected to fail.

							Options:    ${F(a)}
							Diff:       ${a.failureThresholdType==="percent"?`${f}%`:`${f} pixels`}

							Expected:   ${p(e.projectRoot,e.baselinePath)}
							Actual:     ${p(e.projectRoot,e.resultPath)}`);return}if(Q.config.snapshotOptions.updateSnapshot==="all"&&!(a!=null&&a.expectToFail)){await W(t,p(e.projectRoot,e.baselinePath),s);return}throw await W(t,p(e.projectRoot,e.diffPath),m),new Error(L`Snapshot \`${r}\` mismatched

					${a!=null&&a.failureThreshold?(a==null?void 0:a.failureThresholdType)==="percent"?`Expected image to match within ${a.failureThreshold}% but was differ by ${f}%.`:`Expected image to match within ${a.failureThreshold} pixels but was differ by ${f} pixels.`:`Expected image to match but was differ by ${(a==null?void 0:a.failureThresholdType)==="percent"?`${f}%`:`${f} pixels`}.`}${n.width!==s.width||n.height!==s.height?`
The image size changed from ${n.width}x${n.height} to ${s.width}x${s.height}.`:""}

					Options:    ${F(a)}

					Expected:   ${p(e.projectRoot,e.baselinePath)}
					Actual:     ${p(e.projectRoot,e.resultPath)}
					Difference: ${p(e.projectRoot,e.diffPath)}`)}async function W(t,r,e){const a=(await de(e)).split(",")[1];return t.writeFile(r,a,{encoding:"base64"})}async function ue(t,r,e){K(e==null?void 0:e.snapshotKey);const a=await t.preparePageImageSnapshotComparison(r,e);if(a)return he(t,r,a,e)}function me(t){const r=[];let e=t;for(;e!=null&&e.suite;)r.unshift(e.suite.name.replace(/[^a-z0-9]/gi,"-").toLowerCase()),e=e.suite;return r.push(t.name.replace(/[^a-z0-9]/gi,"-").toLowerCase()),r.join("/")}function we(t){const r=ge();return r?ue(xe,me(r),t):Promise.resolve()}let y,M;globalThis.__vitest_browser__&&(C(()=>import("./context-Bznrny0g.js"),[],import.meta.url).then(t=>{t.page.extend({toMatchImageSnapshot:we}),y=t}),C(()=>import("./suite-BL99R7Ot.js"),[],import.meta.url).then(t=>{M=t}));const $e=new Proxy({},{get(t,r){var a;const e=(a=y==null?void 0:y.page)==null?void 0:a[r];return r==="toMatchImageSnapshot"&&e===void 0?()=>{}:e}}),xe=new Proxy({},{get(t,r){var e;return(e=y==null?void 0:y.commands)==null?void 0:e[r]}}),ge=()=>M==null?void 0:M.getCurrentTest();export{K as a,he as b,xe as c,ge as g,$e as p,me as t};
